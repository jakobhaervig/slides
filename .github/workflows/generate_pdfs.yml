name: Convert Reveal.js slides to PDF

on:
  workflow_dispatch:

jobs:
  generate-pdfs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          submodules: recursive

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install Decktape and HTTP server
        run: |
          npm install -g decktape http-server

      - name: Start local HTTP server
        run: |
          nohup npx http-server . -p 8000 > server.log 2>&1 &
          sleep 5  # give the server time to start

      - name: Convert slides to PDF
        run: |
          mkdir -p pdfs
          ignore_folders=("reveal.js" "__pycache__")
          for folder in */; do
            folder=${folder%/}  # remove trailing slash
            if [[ " ${ignore_folders[*]} " == *" $folder "* ]]; then
              continue
            fi
            for file in "$folder"/*.html; do
              [ -e "$file" ] || continue
              filename=$(basename "$file" .html)
              mkdir -p pdfs/"$folder"
              decktape --chrome-arg="--no-sandbox" reveal "http://127.0.0.1:8000/$folder/$filename.html" "pdfs/$folder/$filename.pdf"
            done
          done

      - name: Upload PDFs
        uses: actions/upload-artifact@v4
        with:
          name: pdfs
          path: pdfs/
