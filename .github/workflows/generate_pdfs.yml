name: Convert Reveal.js slides to PDF

permissions:
  contents: write   # allows pushing commits back to the repo

on:
  workflow_dispatch:

jobs:
  generate-pdfs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install Decktape and HTTP server
        run: |
          npm install -g decktape http-server

      - name: Start local HTTP server
        run: |
          nohup npx http-server . -p 8000 > server.log 2>&1 &
          sleep 5  # give the server time to start

      - name: Convert slides to PDF
        run: |
          mkdir -p pdfs
          ignore_folders=("reveal.js" "__pycache__")
          for folder in */; do
            folder=${folder%/}
            if [[ " ${ignore_folders[*]} " == *" $folder "* ]]; then
              continue
            fi
            for file in "$folder"/*.html; do
              [ -e "$file" ] || continue
              filename=$(basename "$file" .html)
              mkdir -p pdfs/"$folder"
              decktape --chrome-arg="--no-sandbox" reveal \
                "http://127.0.0.1:8000/$folder/$filename.html?print-pdf" \
                "pdfs/$folder/$filename.pdf"
            done
          done

      - name: Commit and push PDFs
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -f pdfs   # force add in case of .gitignore

          # Commit if there are changes
          if ! git diff --cached --quiet; then
            git commit -m "Update generated PDFs [skip ci]"
          else
            echo "No PDF changes to commit"
          fi

          # Always pull latest remote changes to avoid push conflicts
          git pull --rebase origin main

          # Push only if there are local commits not on remote
          if ! git diff --quiet origin/main; then
            git push origin main
          else
            echo "Nothing to push"
          fi